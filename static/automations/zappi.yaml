- alias: "Zappi control"
  mode: single
  trigger:
    - platform: state
      entity_id:
        - sensor.current_energy_intent
        - select.myenergi_zappi_charge_mode
        - switch.octopus_energy_00000000_0002_4000_8020_00000008191c_intelligent_smart_charge
        - binary_sensor.id3_charging_cable_connected
  action:
    - choose:
        - alias: "ID3 Smart Charge"
          conditions:
            - alias: "ID3 smart charge enabled"
              condition: state
              entity_id: switch.octopus_energy_00000000_0002_4000_8020_00000008191c_intelligent_smart_charge
              state: "on"
            - alias: "ID3 cable connected"
              condition: state
              entity_id: binary_sensor.id3_charging_cable_connected
              state: "on"
            - alias: "Zappi currently stopped"
              condition: state
              entity_id: select.myenergi_zappi_charge_mode
              state: "Stopped"
          sequence:
            - alias: "Set Zappi to Fast"
              service: select.select_option
              target:
                entity_id: select.myenergi_zappi_charge_mode
              data:
                option: "Fast"
        - alias: "Charge"
          conditions:
            - alias: "Current energy intent is Charge"
              condition: state
              entity_id: sensor.current_energy_intent
              state: "Charge"
            - alias: "Zappi currently stopped"
              condition: state
              entity_id: select.myenergi_zappi_charge_mode
              state: "Stopped"
          sequence:
            - alias: "Set Zappi to Fast"
              service: select.select_option
              target:
                entity_id: select.myenergi_zappi_charge_mode
              data:
                option: "Fast"
        - alias: "Stop"
          conditions:
            - alias: "Current energy intent is not Charge"
              condition: not
              conditions:
                - condition: state
                  entity_id: sensor.current_energy_intent
                  state: "Charge"
            - alias: "Zappi currently fast"
              condition: state
              entity_id: select.myenergi_zappi_charge_mode
              state: "Fast"
          sequence:
            - alias: "Set Zappi to Stopped"
              service: select.select_option
              target:
                entity_id: select.myenergi_zappi_charge_mode
              data:
                option: "Stopped"
