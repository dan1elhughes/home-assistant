- alias: "Zappi control"
  mode: single
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.octopus_cheap_rate
        - binary_sensor.battery_exporting
        - select.myenergi_zappi_charge_mode
  action:
    - choose:
        - alias: "Start"
          conditions:
            - alias: "Battery not exporting"
              condition: state
              entity_id: binary_sensor.battery_exporting
              state: "off"
            - alias: "Cheap rate"
              condition: state
              entity_id: binary_sensor.octopus_cheap_rate
              state: "on"
            - alias: "Zappi currently stopped"
              condition: state
              entity_id: select.myenergi_zappi_charge_mode
              state: "Stopped"
          sequence:
            - alias: "Set Zappi to Fast"
              service: select.select_option
              target:
                entity_id: select.myenergi_zappi_charge_mode
              data:
                option: "Fast"

        - alias: "Stop"
          conditions:
            - alias: "Not cheap rate"
              condition: state
              entity_id: binary_sensor.octopus_cheap_rate
              state: "off"
            - alias: "Zappi currently fast"
              condition: state
              entity_id: select.myenergi_zappi_charge_mode
              state: "Fast"
          sequence:
            - alias: "Set Zappi to Stopped"
              service: select.select_option
              target:
                entity_id: select.myenergi_zappi_charge_mode
              data:
                option: "Stopped"
