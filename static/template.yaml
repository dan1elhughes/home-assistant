- sensor:
    - name: Occupant count
      state: >
        {{ states.person | selectattr('state', 'equalto', 'home') | list | count }}

    - name: Accumulative electricity cost without standing charge
      icon: mdi:currency-gbp
      unit_of_measurement: "£"
      state: >
        {{ state_attr('sensor.octopus_energy_electricity_15p0706167_2000050773706_current_accumulative_cost', 'total_without_standing_charge') }}

    - name: Accumulative gas cost without standing charge
      icon: mdi:currency-gbp
      unit_of_measurement: "£"
      state: >
        {{ state_attr('sensor.octopus_energy_gas_g4p07003781500_7475340302_current_accumulative_cost', 'total_without_standing_charge') }}

    - name: "Solar power generation"
      device_class: power
      state_class: measurement
      unit_of_measurement: "W"
      state: >
        {% set update_threshold = now() - timedelta(minutes=5) %}
        {% if states.sensor.myenergi_myenergi_hub_power_generation.last_updated < update_threshold %}
          0
        {% else %}
          {{ states('sensor.myenergi_myenergi_hub_power_generation') }}
        {% endif %}

    - name: "Solar power generation paid"
      unit_of_measurement: "£"
      state: >
        {{ (states('sensor.myenergi_myenergi_hub_generated_today') | float * states('input_number.fit_generation_per_kwh') | float) | round(2) }}

    - name: "Export paid"
      unit_of_measurement: "£"
      state: >
        {{ (states('sensor.myenergi_myenergi_hub_grid_export_today') | float * states('sensor.octopus_energy_electricity_15p0706167_2000060833200_export_current_rate') | float) | round(2) }}

    - name: "Garden sensor temperature"
      unit_of_measurement: "°C"
      icon: mdi:thermometer
      state: >
        {{ state_attr('weather.home', 'temperature') }}

    - name: "Garden sensor humidity"
      unit_of_measurement: "%"
      icon: mdi:water-percent
      state: >
        {{ state_attr('weather.home', 'humidity') }}

    - name: "Current energy intent"
      icon: mdi:lightning-bolt
      state: >
        {% set events = state_attr('sensor.energy_intents', 'events') or [] %}
        {% set now_time = now() %}
        {% set ns = namespace(current_intent='Idle') %}
        {% for event in events %}
          {% if event.start and event.end %}
            {% set start_dt = as_datetime(event.start) %}
            {% set end_dt = as_datetime(event.end) %}
            {% if start_dt <= now_time <= end_dt %}
              {% set ns.current_intent = event.intent %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {{ ns.current_intent }}

    - name: "Next energy intent"
      icon: mdi:calendar-clock
      state: >
        {% set events = state_attr('sensor.energy_intents', 'events') or [] %}
        {% set now_time = now() %}
        {% set ns = namespace(found=false, intent='', start='', end='', is_current=false) %}

        {% for event in events %}
          {% if event.start %}
            {% set start_dt = as_datetime(event.start) %}
            {% set end_dt = as_datetime(event.end) if event.end is defined else None %}

            {# current intent #}
            {% if not ns.found and start_dt <= now_time and (end_dt is none or now_time < end_dt) %}
              {% set ns.intent = event.intent %}
              {% set ns.start = start_dt %}
              {% set ns.end = end_dt %}
              {% set ns.found = true %}
              {% set ns.is_current = true %}
            {% endif %}

            {# next intent #}
            {% if not ns.found and start_dt > now_time %}
              {% set ns.intent = event.intent %}
              {% set ns.start = start_dt %}
              {% set ns.found = true %}
            {% endif %}
          {% endif %}
        {% endfor %}

        {% if ns.found %}
          {% if ns.is_current %}
            {{ ns.intent }} until {{ ns.end.strftime('%H:%M') if ns.end else '?' }}
          {% else %}
            {{ ns.intent }} at {{ ns.start.strftime('%H:%M') }}
          {% endif %}
        {% else %}
          None
        {% endif %}

    - name: "Energy intents"
      icon: mdi:calendar
      state: "off"
      attributes:
        events: >
          {% set ns = namespace(charges=[], discharges=[], all_events=[]) %}

          {# ======================================================= #}
          {# 1. COLLECT ALL GUARANTEED CHARGE SLOTS                  #}
          {# ======================================================= #}

          {# --- A. Free Electricity Sessions --- #}
          {% for cal in ['calendar.octopus_energy_a_fad3b08a_octoplus_free_electricity_session'] %}
            {% set start_raw = state_attr(cal, 'start_time') %}
            {% set end_raw = state_attr(cal, 'end_time') %}
            {% if start_raw and end_raw %}
              {% set start = as_datetime(start_raw) %}
              {% set end = as_datetime(end_raw) %}
              {% if end >= now() %}
                {% set ns.charges = ns.charges + [{'start': start, 'end': end, 'intent': 'Charge'}] %}
              {% endif %}
            {% endif %}
          {% endfor %}

          {# --- B. Sensor Attributes (Current/Next Off-Peak) --- #}
          {% for state_type in ['current', 'next'] %}
            {% set start_attr = state_attr('binary_sensor.octopus_energy_electricity_15p0706167_2000050773706_off_peak', state_type + '_start') %}
            {% set end_attr = state_attr('binary_sensor.octopus_energy_electricity_15p0706167_2000050773706_off_peak', state_type + '_end') %}
            {% if start_attr and end_attr %}
              {% set start = as_datetime(start_attr) %}
              {% set end = as_datetime(end_attr) %}
              {% if end >= now() %}
                {% set ns.charges = ns.charges + [{'start': start, 'end': end, 'intent': 'Charge'}] %}
              {% endif %}
            {% endif %}
          {% endfor %}

          {# ======================================================= #}
          {# 2. FLATTEN CHARGE SLOTS (Strict Overlap Only)           #}
          {# ======================================================= #}
          {% set ns_flat = namespace(items=[]) %}
          {% set sorted_charges = ns.charges | sort(attribute='start') %}

          {% for c in sorted_charges %}
            {% if ns_flat.items | length == 0 %}
              {% set ns_flat.items = ns_flat.items + [c] %}
            {% else %}
              {% set last = ns_flat.items[-1] %}
              {# STRICT MERGE: Only if c starts before or exactly when last ends #}
              {% if c.start <= last.end %}
                {% set new_end = c.end if c.end > last.end else last.end %}
                {% set ns_flat.items = ns_flat.items[:-1] + [{'start': last.start, 'end': new_end, 'intent': 'Charge'}] %}
              {% else %}
                {% set ns_flat.items = ns_flat.items + [c] %}
              {% endif %}
            {% endif %}
          {% endfor %}

          {# The flattened charges are now our "Anchors" #}
          {% set flat_charges = ns_flat.items %}

          {# ======================================================= #}
          {# 3. GENERATE DISCHARGE SLOTS                             #}
          {# ======================================================= #}

          {# --- A. Saving Sessions (Calendar) --- #}
          {% for cal in ['calendar.octopus_energy_a_fad3b08a_octoplus_saving_sessions'] %}
            {% set start_raw = state_attr(cal, 'start_time') %}
            {% set end_raw = state_attr(cal, 'end_time') %}
            {% if start_raw and end_raw %}
              {% set start = as_datetime(start_raw) %}
              {% set end = as_datetime(end_raw) %}
              {% if end >= now() %}
                {% set ns.discharges = ns.discharges + [{'start': start, 'end': end, 'intent': 'Discharge'}] %}
              {% endif %}
            {% endif %}
          {% endfor %}

          {# --- B. Pre-Charge Calculations --- #}
          {# Battery Parameters #}
          {% set battery_wh = states('sensor.envoy_122322027694_available_battery_energy') | float(0) %}
          {% set battery_kwh = battery_wh / 1000 %}
          {% set target_percent = 10 %}
          {% set usable_kwh = battery_kwh * (1 - target_percent / 100) %}
          {% set discharge_rate_kw = states('input_number.battery_power_rate_kw') | float(9.6) %}
          {# Max hours we can physically discharge #}
          {% set max_discharge_hours = (usable_kwh / discharge_rate_kw) | float(0) %}

          {% for c in flat_charges %}
            {# Duration of the charge slot #}
            {% set charge_duration_hours = (c.end - c.start).total_seconds() / 3600 %}

            {# Limit discharge time: Min(Battery Capacity, Charge Duration) #}
            {% set hours_to_discharge = max_discharge_hours if max_discharge_hours < charge_duration_hours else charge_duration_hours %}

            {# Calculate Start #}
            {% set d_end = c.start %}
            {% set d_start_raw = d_end - timedelta(hours=hours_to_discharge) %}

            {# Round start down to 10 mins for cleanliness #}
            {% set d_start = d_start_raw.replace(minute=(d_start_raw.minute // 10) * 10, second=0, microsecond=0) %}

            {# Add if valid and in future #}
            {% if d_start < d_end and d_end >= now() %}
              {% set effective_start = d_start if d_start >= now() else now() %}
              {% if effective_start < d_end %}
                {% set ns.discharges = ns.discharges + [{'start': effective_start, 'end': d_end, 'intent': 'Discharge'}] %}
              {% endif %}
            {% endif %}
          {% endfor %}

          {# ======================================================= #}
          {# 4. FINAL PASS: COMBINE AND TRIM (Buffer Enforcement)    #}
          {# ======================================================= #}

          {% set all_raw = flat_charges + ns.discharges %}
          {% set sorted_all = all_raw | sort(attribute='start') %}
          {% set ns_final = namespace(items=[]) %}

          {% for event in sorted_all %}
            {% if ns_final.items | length == 0 %}
              {% set ns_final.items = ns_final.items + [event] %}
            {% else %}
              {% set last = ns_final.items[-1] %}

              {% if event.intent == last.intent %}
                {# -- Same Intent: Merge if touching/overlapping -- #}
                {% if event.start <= last.end %}
                  {% set new_end = event.end if event.end > last.end else last.end %}
                  {% set ns_final.items = ns_final.items[:-1] + [{'start': last.start, 'end': new_end, 'intent': last.intent}] %}
                {% else %}
                  {# GAP PRESERVATION: Maintain gap between non-touching same-intent events #}
                  {% set ns_final.items = ns_final.items + [event] %}
                {% endif %}

              {% else %}
                {# -- Different Intent: Conflict Resolution -- #}
                {% if event.start < last.end %}
                    {# Overlap #}
                    {% if event.intent == 'Charge' %}
                      {# Charge wins. Trim previous Discharge end. #}
                      {% set trimmed_last_end = event.start - timedelta(minutes=5) %}
                      {% if trimmed_last_end > last.start %}
                          {% set ns_final.items = ns_final.items[:-1] + [{'start': last.start, 'end': trimmed_last_end, 'intent': last.intent}] %}
                          {% set ns_final.items = ns_final.items + [event] %}
                      {% else %}
                          {% set ns_final.items = ns_final.items[:-1] + [event] %}
                      {% endif %}
                    {% else %}
                      {# Charge wins. Trim current Discharge start. #}
                      {% set trimmed_event_start = last.end + timedelta(minutes=5) %}
                      {% if trimmed_event_start < event.end %}
                        {% set ns_final.items = ns_final.items + [{'start': trimmed_event_start, 'end': event.end, 'intent': event.intent}] %}
                      {% endif %}
                    {% endif %}
                {% else %}
                    {# Gap check #}
                    {% set gap = (event.start - last.end).total_seconds() / 60 %}
                    {% if gap < 5 %}
                      {# Buffer violation #}
                      {% if event.intent == 'Charge' %}
                          {% set required_end = event.start - timedelta(minutes=5) %}
                          {% if required_end > last.start %}
                            {% set ns_final.items = ns_final.items[:-1] + [{'start': last.start, 'end': required_end, 'intent': last.intent}] %}
                            {% set ns_final.items = ns_final.items + [event] %}
                          {% else %}
                            {% set ns_final.items = ns_final.items[:-1] + [event] %}
                          {% endif %}
                      {% else %}
                          {% set required_start = last.end + timedelta(minutes=5) %}
                          {% if required_start < event.end %}
                            {% set ns_final.items = ns_final.items + [{'start': required_start, 'end': event.end, 'intent': event.intent}] %}
                          {% endif %}
                      {% endif %}
                    {% else %}
                      {% set ns_final.items = ns_final.items + [event] %}
                    {% endif %}
                {% endif %}
              {% endif %}
            {% endif %}
          {% endfor %}

          {# ======================================================= #}
          {# 5. OUTPUT JSON                                          #}
          {# ======================================================= #}
          {% set ns_json = namespace(output=[]) %}
          {% for e in ns_final.items %}
            {% set ns_json.output = ns_json.output + [{'start': e.start.isoformat(), 'end': e.end.isoformat(), 'intent': e.intent}] %}
          {% endfor %}
          {{ ns_json.output | to_json }}

    - name: "Battery total power"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      state: >
        {{
          (
            states('sensor.encharge_492452002777_power') | float(0)
            +
            states('sensor.encharge_492452002785_power') | float(0)
            +
            states('sensor.encharge_492452002787_power') | float(0)
          )
        }}

    - name: "Battery total discharge power"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      state: >
        {% set p = states('sensor.battery_total_power') | float(0) %}
        {{ p if p > 0 else 0 }}

    - name: "Battery total charge power"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      state: >
        {% set p = states('sensor.battery_total_power') | float(0) %}
        {{ (p * -1) if p < 0 else 0 }}

    - name: "Battery energy charged"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing
      state: >
        {{ (states('input_number.battery_energy_charged_wh') | float(0)) / 1000 }}

    - name: "Battery energy discharged"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing
      state: >
        {{ (states('input_number.battery_energy_discharged_wh') | float(0)) / 1000 }}

- binary_sensor:
    - name: One-room mode
      state: >
        {{ states('sensor.occupant_count') | int <= 1 }}

- switch:
    - turn_on:
        - target:
            entity_id:
              - climate.barn_ac
          data:
            hvac_mode: heat
          action: climate.set_hvac_mode
      turn_off:
        - target:
            entity_id:
              - climate.barn_ac
          data:
            hvac_mode: "off"
          action: climate.set_hvac_mode
      default_entity_id: switch.barn_ac_power
      name: Barn AC Power
      state: "{{ states('climate.barn_ac') in ['heat','cool','heat_cool','fan_only','dry'] }}"
