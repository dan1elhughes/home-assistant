- sensor:
    - name: Occupant count
      state: >
        {{ states.person | selectattr('state', 'equalto', 'home') | list | count }}

    - name: Next saving session
      state: >
        {{ state_attr('binary_sensor.octopus_energy_a_fad3b08a_octoplus_saving_sessions', 'next_joined_event_start') }}

    - name: Accumulative electricity cost without standing charge
      icon: mdi:currency-gbp
      unit_of_measurement: "£"
      state: >
        {{ state_attr('sensor.octopus_energy_electricity_15p0706167_2000050773706_current_accumulative_cost', 'total_without_standing_charge') }}

    - name: Accumulative gas cost without standing charge
      icon: mdi:currency-gbp
      unit_of_measurement: "£"
      state: >
        {{ state_attr('sensor.octopus_energy_gas_g4p07003781500_7475340302_current_accumulative_cost', 'total_without_standing_charge') }}

    - name: "Solar power generation"
      unit_of_measurement: "W"
      state: >
        {% set update_threshold = now() - timedelta(minutes=5) %}
        {% if states.sensor.myenergi_myenergi_hub_power_generation.last_updated < update_threshold %}
          0
        {% else %}
          {{ states('sensor.myenergi_myenergi_hub_power_generation') }}
        {% endif %}

    - name: "Solar power generation paid"
      unit_of_measurement: "£"
      state: >
        {{ (states('sensor.myenergi_myenergi_hub_generated_today') | float * states('input_number.fit_generation_per_kwh') | float) | round(2) }}

    - name: "Export paid"
      unit_of_measurement: "£"
      state: >
        {{ (states('sensor.myenergi_myenergi_hub_grid_export_today') | float * states('sensor.octopus_energy_electricity_15p0706167_2000060833200_export_current_rate') | float) | round(2) }}

    - name: "Garden sensor temperature"
      unit_of_measurement: "°C"
      icon: mdi:thermometer
      state: >
        {{ state_attr('weather.home', 'temperature') }}

    - name: "Garden sensor humidity"
      unit_of_measurement: "%"
      icon: mdi:water-percent
      state: >
        {{ state_attr('weather.home', 'humidity') }}

    # Time until off-peak rate
    - name: "Time until offpeak rate"
      unit_of_measurement: "minutes"
      state: >
        {% set next_rate = (states('sensor.octopus_energy_electricity_15p0706167_2000050773706_next_rate') | float(0)) * 100 %}
        {% set threshold = states('input_number.octopus_cheap_threshold') | float(0) %}
        {% set start_time = state_attr('sensor.octopus_energy_electricity_15p0706167_2000050773706_next_rate', 'start') %}
        {% if start_time and next_rate < threshold %}
          {% set start_dt = as_datetime(start_time) %}
          {% set delta = (start_dt - now()).total_seconds() / 60 %}
          {{ [delta, 0] | max | round(0) }}
        {% else %}
          unknown
        {% endif %}

    # Time until peak rate
    - name: "Time until peak rate"
      unit_of_measurement: "minutes"
      state: >
        {% set next_rate = (states('sensor.octopus_energy_electricity_15p0706167_2000050773706_next_rate') | float(0)) * 100 %}
        {% set threshold = states('input_number.octopus_cheap_threshold') | float(0) %}
        {% set start_time = state_attr('sensor.octopus_energy_electricity_15p0706167_2000050773706_next_rate', 'start') %}
        {% if start_time and next_rate >= threshold %}
          {% set start_dt = as_datetime(start_time) %}
          {% set delta = (start_dt - now()).total_seconds() / 60 %}
          {{ [delta, 0] | max | round(0) }}
        {% else %}
          unknown
        {% endif %}

    - name: "Time to fully charge"
      unit_of_measurement: "minutes"
      state: >
        {% set current = states('sensor.envoy_122322027694_available_battery_energy') | float(0) %}
        {% set capacity = states('sensor.envoy_122322027694_battery_capacity') | float(0) %}
        {% set rate_kw = states('input_number.battery_power_rate_kw') | float(0) %}
        {% set rate_w = rate_kw * 1000 %}
        {% set remaining = capacity - current %}
        {% if remaining > 0 and rate_w > 0 %}
          {{ ((remaining / rate_w) * 60) | round(0) }}
        {% else %}
          0
        {% endif %}

    - name: "Time to fully discharge"
      unit_of_measurement: "minutes"
      state: >
        {% set current = states('sensor.envoy_122322027694_available_battery_energy') | float(0) %}
        {% set rate_kw = states('input_number.battery_power_rate_kw') | float(0) %}
        {% set rate_w = rate_kw * 1000 %}
        {% if current > 0 and rate_w > 0 %}
          {{ ((current / rate_w) * 60) | round(0) }}
        {% else %}
          0
        {% endif %}

- binary_sensor:
    - name: One-room mode
      state: >
        {{ states('sensor.occupant_count') | int <= 1 }}

    - name: Restart required
      state: >
        {{  states.update
          | selectattr('attributes.release_summary','eq','<ha-alert alert-type=\'error\'>Restart of Home Assistant required</ha-alert>')
          | list
          | count > 0
        }}

    - name: Octopus cheap rate
      state: >
        {% set rate = states('sensor.octopus_energy_electricity_15p0706167_2000050773706_current_rate') | float %}
        {% set threshold = states('input_number.octopus_cheap_threshold') | float / 100 %}
        {{ rate < threshold }}

    - name: Battery exporting
      state: >
        {{ states('sensor.envoy_122322027694_current_power_consumption') | float * 1000 < states('input_number.battery_export_threshold') | float }}
